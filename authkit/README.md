# AuthKit

Authentication and RBAC module for Spring Boot 2 (Java 11).

It's still in alpha.

![Java CI with Maven](https://github.com/hdsdi3g/authkit/workflows/Java%20CI%20with%20Maven/badge.svg)

[![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=hdsdi3g_authkit&metric=alert_status)](https://sonarcloud.io/dashboard?id=hdsdi3g_authkit)

![CodeQL](https://github.com/hdsdi3g/authkit/workflows/CodeQL/badge.svg)

---

AuthKit provide a backend API & logon front with:

- User/Group/Role/Right (access to a controller)/Right Context (access context limitation for a controller) as RBAC objects
- Cookie-less and persistence-less session based on JSON web tokens via an HTTP bearer.
- Cookie stateless/session less (same JWT from bearer) for non-REST purpose.
- Optional 2 factors auth (TOTP)
- Optional login by Active Directory via an LDAP auth
- A Role can required a specific IP address before it enable during a request
- Data persistance with the help of an Hibernate database compatible, like MySQL and H2.
- Strongly tested by [integration tests](https://sonarcloud.io/component_measures?id=hdsdi3g_authkit&metric=Coverage)
- An internal and systematic audit system on database, for trace any security/logon actions.
- A ciphered and isolated table for storing personal information (privacy). An user is only referenced by its auto-generated UUID. The username (login name) is only manipulated during logon operations.

AuthKit don't use Spring Security functions: it can be setup in addition for Spring Security.

It's use Liquibase for setup/upgrade MySQL database via [setupdb](https://github.com/hdsdi3g/setupdb-maven-plugin), only if you don't want to use Hibernate to do it.

## Changelog

| Version          | Status   | Database updated schema | Supported on security terms |
| ---------------- | -------- | ----------------------- | --------------------------- |
| 0.0.1 to 0.2.1   | Inactive | n/a                     | no                          |
| 0.3.0            | Active   | no                      | yes                         |

## Policy security

### Reporting a vulnerability

Please open an issue in GitHub with:

- the problem description
- an evaluated gravity

If, and only if you consider the vulnerability is severe (like bypass validations or invalid right changes), free feel to contact all project maintainers as declared in pom.xml file.

Only Authkit-relative problems are accepted!
However, misinterpretation of documentation or poorly documented functionality can lead to flaws. Do not hesitate to point out anything that is not completely clear in the documentation.
In that case, open an issue and/or propose a documentation pull request.

Keep connected, via Github, of all project updates: some may relate to security.

### Implemented policy

An non-logged guest can't create an account.

No specific "administrator account" rights, just an regular user with all grant rights.

All active users can:

- activate and disable TOTP, even with an LDAP authentication.
- get and update all privacy informations stored in database.
- change password anytime, except those logged by LDAP

All IP restrictions and loggin are for IPv4 and IPv6.

All HTML forms should use a JWT token with a short-time (configurable) life, specific for the form, independently with cookie auth.

Except for login and audit operations, users are only denominated by an autogenerated UUID in database/logs.

An user account limit the failed logon tries, and after blocking, only a `SecurityAdmin` can unlock it. `SecurityAdmin` can also block future logons for an user.

Expirations:

- Short session time are tuned for 10 min by default.
- Long session time are tuned for 24h by default.

_Argon2_ is the password hasher, configured by default:

- 10 iterations
- 2048 kb
- 2 parallelism

Data hasher (except passwords) use _SHA3-512_.

Data cipher user, configured by default:

- AES
- 12 IV size
- transformation: AES/GCM/NoPadding
- GCMParameterSpecLen 128

Random generator use `NATIVEPRNGNONBLOCKING`, or else use `SecureRandom.getInstanceStrong();`

Hmac generated use `HmacSHA256`.

### Passwords

Password size/complexity have two strategies, only the slight ("default") is enabled.

| Strategy name  | password min size | must_have_special_chars |
| -------------- | ----------------- | ----------------------- |
| default        | 8                 | no                      |
| strong         | 20                | yes                     |

All values are re-configurable.
Complexity is computed after remove:

- spaces
- passwords consisting of repetitive or sequential characters (e.g. ‘aaaaaa’, ‘1234abcd’)
- some generic terms, like "password", "admin", "administrator", "root"
- some context-specific words, such as the name of the service, the username, and derivatives thereof

### RBAC Model

- Users can belong to several Groups
- Users, Credentials information and user privacy metadata are stored in separate tables in database
- Group can acquire several Roles
- Roles are simple aggregates of Rights
- Roles can by conditioned by an IP address
- Right is a Java annotation on Spring Controller
- Any Right can have Context for limit ressource/data acces usage in a controller

User session JWT (via cookie or http bearer) tokens handle and keep Right-name list.

## Built With

- Java 11
- SpringBoot, with Web, Thymeleaf, Configuration, JPA, LDAP
- Apache log4j2, commons
- jsonwebtoken.io jjwt
- mkammerer.de Argon2
- Junit 5 Jupiter
- MySQL Client Connector
- H2 DB connector for tests
- Hibernate
- Google Zxing (QR code generator) use by TOTP functions
- Edin Dazdarevic CIDRUtils
- Liquibase for handle database structure updates

See pom.xml and THIRD-PARTY.txt files for more details.

## Setup and installation

Installation can be doing in the main project who needs AuthKit, or as stand-alone for testing/debug/development needs.

### Requirement

A correctly setup of **OpenJDK 11.x**. AdoptOpenJDK distributions will be fine. No matter for Windows, macOS or Linux.

Main project needs to work from **Spring Boot v2.3.7.RELEASE** or superior. It's not tested/validated with others versions.

Database technology is validated on **MySQL 8.x, community server GPL** and **H2**. It can run on any Hibernate compatible databases (in this case, you must adapt manually all the Liquibase declarations, or let Hibernate take care of database schemas).

**Apache Maven 3.6.x** for building, **git** for retrieve code (some setup tools needs git) and some **bash** for simple shortcut scripts.

### Full setup

`git clone https://github.com/hdsdi3g/authkit.git` sources from GitHub.

#### For use AuthKit in a maven project

And add dependency to your new project pom.xml:

```xml
<dependency>
  <groupId>tv.hd3g</groupId>
  <artifactId>authkit</artifactId>
  <version>VERSION</version>
</dependency>
```

Replace VERSION by [the last published version](https://mvnrepository.com/artifact/tv.hd3g/authkit).

#### AuthKit development

Please setup an `application.yml` and `log4j2.xml` in `/config`. You can use samples in `src/test/resources`, or just ignore `/config` and keep the ones in `resources` (`/config` is outside git control).

In case if you want use an external MySQL database, after configure the Spring application, like:

```yaml
spring:
    datasource:
        url: jdbc:mysql://localhost:3306/authkit?useSSL=false&useLegacyDatetimeCode=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
        username: local
        password: ""
    jpa:
        properties:
            hibernate:
                dialect: "org.hibernate.dialect.MySQL8Dialect"
                jdbc:
                     time_zone: "UTC"
        hibernate:
            ddl-auto: validate
        open-in-view: false
```

Run:

```shell
mvn setupdb:deploy
```

for deploy manually the database configuration, and use:

```shell
mvn setupdb:dropall
```

For a full reverse setup. More information on setupdb in [setupdb's README](https://github.com/hdsdi3g/setupdb-maven-plugin/blob/master/README.md).

_For maven calls, you can stop internal tests and gpg jar sign with:_

```shell
mvn <verbs> -DskipTests=true -Dgpg.skip=true
```

For update API.md, use:

```shell
scripts/make-rest-doc.sh
```

#### AuthKit as library or in production

If you want use Liquibase outside maven, please generate a `/target/database-full-archive-changelog.xml` with:

```shell
mvn setupdb:archive
```

And you will be able to use, with a valid setup, **Liquibase v3.x** with the MySQL JDBC connector **mysql-connector-java-8.x.jar** putted in the liquibase setup **lib** directory.

More information on [Liquibase doc site](https://docs.liquibase.com/).

#### AuthKit configuration

Create/edit _log4j2.xml_ in classpath. Nothing special, just don't forget it. An example is provided in `scripts/log4j2-tests.xml` (good for automated tests) and in `src/test/resources`.

Create/edit _application.properties_ or _application.yml_. And YAML file for example and test purpose is provided also in `src/test/resources`. You should take care of:

- `spring.datasource.url`, `username` **and** `password`
- `spring.datasource.driver-class-name` _or_ `spring.jpa.properties.hibernate.dialect`
- `server.port`
- `authkit.realm`, used for specific Authkit needs.

You **MUST** set `jwt_secret` and `cipher_secret` with _secret-generator_ the sames for all shared database access and websites backend instance.

#### AuthKit secret-generator

Just starts `java scripts/secret-generator.java` and get new secrets in `secret-application.yml`. After get entries, you can delete `secret-application.yml` file.

#### Build Spring Boot App

You can build App:

- Just AuthKit for standalone operations
- Your app with AuthKit in dependencies

Add the spring-boot-maven-plugin in `pom.xml`:

```xml
<plugin>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-maven-plugin</artifactId>
    <executions>
        <execution>
            <goals>
                <goal>repackage</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

And starts `mvn package -DskipTests=true -Dgpg.skip=true`

#### Create security admin

After build, prepare a config directory containing an `application.yml` or `application.properties`, and run:

```bash
scripts/create-security-admin.sh
```

Or, manually:

```bash
export AUTHKIT_NEWADMIN=<security admin login name>
export AUTHKIT_PASSWORD=<security admin password>
java -jar myspringapp.jar create-security-admin
```

The newer created security admin will have all code declared rights. Repeat operation for another admin, for overwrite actual admin password, during troubleshooting, or if you needs too add all newer rights in one shot.

### Upgrade

Prepare a database upgrade environment based on setup (Liquibase and `database-full-archive-changelog.xml` file).

Upgrading AuthKit may require:

- to update database before upgrade
- to update database after upgrade
- to add or change configuration entries

For all cases, database updating will be managed by Liquibase, and _should be_ reversible.

Remember that you don't have to use Liquibase if you use Hibernate to do that. Nothing special here.

## Usage in an external project

Now, after add authkit in your `pom.xml`, let's use AuthKit in you project.

Create a class with annotations like:

```java
@Configuration
@ComponentScan(basePackages = { "tv.hd3g.authkit.mod" })
@EnableJpaRepositories("tv.hd3g.authkit.mod.repository")
@EntityScan("tv.hd3g.authkit.mod.entity")
public class Setup {
    /* Other configuration declarations */
}
```

### Right checks

And add on Controller some annotations:

```java
@Controller
@CheckBefore("secureOnClass")
public class ControllerWithSecure {

    @CheckBefore("secureOnMethod")
    public void verbWithSecure() {
    }

    public void verbWithoutSecure() {
    }
}
```

An user must have rights for:

- `secureOnClass` **and** `secureOnMethod` for call `verbWithSecure()`
- just `secureOnClass` for call `verbWithoutSecure()`

### Audit after call controller

Go to `src/test/java/tv/hd3g/dummy/controller/ControllerAudit.java` to see an example.

All `@AuditAfter` annotations will add a database entry and a log entry after each call, and some request information (like IP, user UUID...) will be stored.

## Contributing / debugging

For run the tests, you needs Maven, a fully setup database and a valid application.yml (more precisely a valid Spring Boot configuration file).

The new code quality must be checked by SonarQube and should never have a bad note.

Versioning: just use [SemVer](https://semver.org/).

## Roadmap

It will be mainly to reinforce and stabilize actual functions.

Some functions maybe added like:

- Connected user send Reset Password order (via a mail), and reset it.
- Connected user can send invitations to simplify new user operations (supported by some specific tokens, and the mail send).
- Better LDAP tools with account synchronization
- a dedicated Front-end to edit RBAC rights
- A token type dedicated for API access (no-expiration token)
- Search user API

## Author and License

This project is writer by [hdsdi3g](https://github.com/hdsdi3g) and licensed under the LGPL License; see the LICENCE.TXT file for details.
